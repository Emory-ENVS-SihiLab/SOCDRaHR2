---
title: "ISCN 3_1"
author: "Dr. Katherine Todd-Brown, Julie Bielecki, Anne Davin, Rita Hippe, Urmi Thorat"
date: "5/25/2021"
output: html_document
---

# Introduction

International Soil Carbon Network 3 (ISCN3) consists of serveral data sets. This R Markdown cleans and reorganizes ISCN3 datasets into a study level table, a profile level table, and a layer level table using the ISCN3_1 function. Additionally, maps for each data set are produced within this R Markdown.

The `study` table produced by the ISCN3_1 function describe information about each data contribution including any citations practices and contact information for the contributor. The `profile` table produced by the ISCN3_1 function describes core summary information that is 2D resolved.In contrast, the `layer` table produced the ISCN3_1 function holds 3D resolved information.


```{r warning=FALSE, message=FALSE}
library(data.table)
library(SOCDRaH2)
library(tidyverse)
library(lubridate)
library(tibble)
library(ggmap)
library(maps)
library(mapdata)
library(knitr)
library(tidyr)

data_dir <- '../ISCN3'

ISCN3 <- ISCN3_1(data_dir)
```


```{r message=FALSE, warning=FALSE}
knitr::kable(t(dataset_study))
```


There are the following factors in the profile:

```{r}
knitr::kable(summary(dataset_profile %>% select_if(is.factor)))
```

And the following factors in the layers:
```{r}
knitr::kable(summary(dataset_layer %>% select_if(is.factor)))
```


## Location
```{r}
ggplot(data =  map_data("world")) + 
  geom_polygon(aes(x=long, y = lat, group = group), 
               fill = 'grey', color = 'black') + 
  geom_point(data= dataset_profile, 
             aes(x = `long (dec. deg)`, y = `lat (dec. deg)`),
             shape = 'x', color = 'red') +
  coord_fixed(1.3) +
  theme_nothing() +
  labs(title = 'Profile data') #+
  #coord_map("ortho", orientation = c(90, 0, 0))
ggplot(data =  map_data("world")) + 
  geom_polygon(aes(x=long, y = lat, group = group), 
               fill = 'grey', color = 'black') + 
  geom_point(data= dataset_layer %>% select(`long (dec. deg)`, `lat (dec. deg)`) %>% unique(), 
             aes(x = `long (dec. deg)`, y = `lat (dec. deg)`),
             shape = 'x', color = 'red') +
  coord_fixed(1.3) +
  theme_nothing() +
  labs(title = 'Layer data')
```


## Use if map is not centered around the specific region of dataset
```{r}
#country <- ggplot2::map_data('world2', 'usa')
#avgLat <- dataset_layer %>% 
#  pull('lat (dec. deg)') %>%
#  mean()
#avgLong <- dataset_layer %>% 
#  pull('long (dec. deg)') %>%
#  mean() + 360
#ggplot(data =  map_data("world2")) +
#  geom_polygon( aes(x = long, y = lat, group = group),
#                fill = 'grey', color = "black") +
#  geom_polygon(data = country, aes(x = long, y = lat, group = group),
#                fill = 'lightblue', color = "black") +
#  geom_point(data = dataset_profile, aes(x = avgLong, y = avgLat), shape = 'x', color = 'red', size = 5) +
#  coord_cartesian(xlim=c(avgLong - 65, avgLong + 65), ylim = c(avgLat - 25, avgLat + 25)) +
#  theme_nothing() +
#  labs(title = 'Profile data')
#ggplot(data =  map_data("world2")) + 
#  geom_polygon(aes(x=long, y = lat, group = group), 
#               fill = 'grey', color = 'black') + 
#  geom_polygon(data = country, aes(x = long, y = lat, group = group),
#                fill = 'lightblue', color = "black") +
#  geom_point(data = dataset_layer, aes(x = `long (dec. deg)` + 360, y = `lat (dec. deg)`),
#             shape = 'x', color = 'red', size = 2.5) +
#  coord_cartesian(xlim=c(avgLong - 9.1, avgLong + 9.1), ylim = c(avgLat - 3.5, avgLat + 3.5)) +
#  theme_nothing() +
#  labs(title = 'Layer data')
  
```

```{r eval=FALSE}
#this is useful to see for the analysis but we don't want it in the report
dataset_layer %>%
  pivot_longer(cols = intersect(names(.), type_cols$num_cols), values_drop_na = TRUE) %>%
  group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) %>%
  bind_rows(
    dataset_layer %>%
      pivot_longer(cols = intersect(names(.), type_cols$factor_cols), values_drop_na = TRUE) %>%
      group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) ) %>%
  arrange(n) %>%
  knitr::kable()
```

## Profile histograms

```{r}
ggplot(dataset_profile %>%
         pivot_longer(cols = intersect(names(.), type_cols$num_cols), 
                      values_to = 'measurement', names_to = 'type')) +
  geom_histogram(aes(x=measurement)) +
  facet_wrap(~type, scales='free') +
  theme_bw()
```

## Depth plots

```{r}
ggplot(dataset_layer %>% 
         pivot_longer(cols=c('layer_top (cm)', 'layer_bot (cm)'),
                       values_to='depth') %>%
         pivot_longer(cols = intersect(names(.), type_cols$num_cols), 
                      values_to = 'measurement', names_to = 'type')) +
         geom_line(aes(x=depth, y= measurement, group = profile_name), alpha = 0.5) +
  facet_wrap(~type, scales='free') +
  theme_bw()
```


## Individualized tables, maps, histograms, and depth plots by dataset



## Plot-generating function 
```{r}
# TODO Implement special case code
# TODO Average coordinates for base map code
# TODO Verify that all "single country" datasets are in US

plotGenerate <- function(ISCN3, datasetName){
  
### VARIABLE SETTING ####
  datasetLayer <- ISCN3$layer %>%
             filter(dataset_name_sub == datasetName)
  
  
  fixedCountryLayerData <- 
    if(is.na(datasetLayer$`country (country)`[1])) {
                                datasetLayer %>%
                                mutate(`country (country)` = as.factor(c("United States")))
    } else if(datasetLayer$`country (country)`[1] == "Unknown") {
                                datasetLayer %>%
                                mutate(`country (country)` = as.factor(c("United States")))
    } else{datasetLayer}
  
  
#### TABLES ####  
   studyTable <- knitr::kable(t(ISCN3$study %>%
                        filter(dataset_name == datasetName) %>%
                        dplyr::select(where(function(xx){!all(is.na(xx))}))),
                              col.names = "",
                              caption = paste("A summary of [", datasetName,
                                        "] study and contact information.", sep = ""))
   
   profileTable <- 
          if(datasetName %in% ISCN3$profile$dataset_name_sub){
            
                  knitr::kable(summary(ISCN3$profile %>%
                        filter(dataset_name_sub == datasetName) %>%
                        dplyr::select(where(function(xx){!all(is.na(xx))})) %>%
                        select_if(is.factor) %>%
                        mutate_all(droplevels)),
                        caption = paste("A summary of [", datasetName,
                                        "] profile data,  \nwhich is 2D resolved information.", sep = ""))
            
          } else {NA}
   
      
   layerTable <- knitr::kable(summary(fixedCountryLayerData %>%
                        dplyr::select(where(function(xx){!all(is.na(xx))})) %>%
                        select_if(is.factor) %>%
                        mutate_all(droplevels)),
                        caption = paste("A summary of [", datasetName,
                                        "] layer data,  \ncontaining 3D resolved information.", sep = ""))  
 #### MAP CODE ####  
   
   profileMap <-  if(datasetName %in% ISCN3$profile$dataset_name_sub) #checking if dataset has profile data
   {
     
     if (length(unique(ISCN3$profile %>%
                       filter(dataset_name_sub == datasetName) %>%
                       select(`country (country)`))) > 1 ) #checking if world map needed
     {
       ggplot(data =  map_data("world")) + 
         geom_polygon(aes(x=long, y = lat, group = group), 
                      fill = 'grey', color = 'black') + 
         geom_point(data= ISCN3$profile %>%
                      filter(dataset_name_sub == datasetName), 
                    aes(x = `long (dec. deg)`, y = `lat (dec. deg)`),
                    shape = 'x', color = 'red') +
         coord_fixed(1.3) +
         theme_grey() +
         labs(title = 'Profile Data Map',
              caption = paste("A map of [", datasetName,
                              "] sampling sites,  \nusing coordinates found within the profile data.", sep = ""))
       
     } else { #use auto-scaling map code to see site locations better
       
       baseLat <- ISCN3$profile %>%
         filter(dataset_name_sub == datasetName) %>%
         dplyr::pull('lat (dec. deg)')
       
       baseLong <- ISCN3$profile %>%
         filter(dataset_name_sub == datasetName) %>%
         dplyr::pull('long (dec. deg)')
       
       rangeLat <- if (diff(range(baseLong, na.rm = TRUE)) <= 5.0){
         diff(range(baseLong, na.rm = TRUE)) * 18
       } else {
         diff(range(baseLong, na.rm = TRUE)) * 22
       }
       
       calcLat <- rangeLat * 2.6
       
       
       ggplot(data =  map_data("world2")) + 
         geom_polygon(aes(x=long, y = lat, group = group), 
                      fill = 'grey', color = 'black') + 
         geom_polygon(data = ggplot2::map_data('world2', 'usa'),
                      aes(x = long, y = lat, group = group),
                      fill = 'lightblue', color = 'black') +
         geom_point(data= ISCN3$profile %>%
                      filter(dataset_name_sub == datasetName),
                    aes(x = `long (dec. deg)` + 360,
                        y = `lat (dec. deg)`),
                    shape = 'x', color = 'red') +
         coord_cartesian(xlim = c(mean(baseLong, na.rm = TRUE) + 360 - calcLat,
                                  mean(baseLong, na.rm = TRUE) + 360 + calcLat),
                         ylim = c(mean(baseLat, na.rm = TRUE) - rangeLat,
                                  mean(baseLat, na.rm = TRUE) + rangeLat)) +
         theme_grey() +
         xlab("Longitude") + ylab("Latitude") +
         labs(title = 'Profile Data Map',
              caption = paste("A map of [", datasetName,
                              "] sampling sites,  \nusing coordinates found within the profile data.", sep = ""))
       #coord_map("ortho", orientation = c(90, 0, 0))
     }
   # } else if (fixedCountryLayerData$`country (country)`[1] == "United States") {   
   #   
   #   ###use layer info to set state, and highlight state of interest on US map
   #   ggplot(data =  map_data('state')) +
   #     geom_polygon(aes(x=long, y = lat, group = group), 
   #             fill = 'grey', color = 'black') +
   #     geom_polygon(data = datasetLayer %>%
   #                    select(`state (state_province)`) %>%
   #                    map_data(),
   #             aes(x=long, y = lat, group = group),
   #             fill = 'blue', color = 'black') +
   #     coord_fixed(1.3) + 
   #     theme_nothing() + 
   #     theme_grey() +
   #     xlab("Longitude") + ylab("Latitude") +
   #     labs(title = 'Highlighted Layer Data Map',
   #          caption = paste("A U.S. map of where [", datasetName,
   #                          "] sampling occured,  \nusing layer information since this dataset does not have profile information.", sep = ""))
     
   # ^STILL DEBUGGING
     
     
     
   } else {NA} 
   
   
 
  
   layerMap <- if (length(unique(ISCN3$profile %>%
                        filter(dataset_name_sub == datasetName) %>%
                        select(`country (country)`))) > 1 ) #using world map if sites span multiple countries
                    {

                     ggplot(data =  map_data("world")) + 
                       geom_polygon(aes(x=long, y = lat, group = group), 
                                    fill = 'grey', color = 'black') + 
                       geom_point(data= dataset_layer %>% select(`long (dec. deg)`, `lat (dec. deg)`) %>% unique(), 
                                  aes(x = `long (dec. deg)`, y = `lat (dec. deg)`),
                                  shape = 'x', color = 'red') +
                       coord_fixed(1.3) +
                       theme_grey() +
                       xlab("Longitude") + ylab("Latitude") +
                       labs(title = 'Layer Data Map',
                            caption = paste("A map of [", datasetName,
                                            "] sampling sites,  \nusing coordinates found within the layer data.",
                                            sep = ""))
     
     
                     } else {
                       baseLat <- ISCN3$layer %>%
                         filter(dataset_name_sub == datasetName) %>%
                         dplyr::pull('lat (dec. deg)')
                       
                       baseLong <- ISCN3$layer %>%
                         filter(dataset_name_sub == datasetName) %>%
                         dplyr::pull('long (dec. deg)')
                       
                       rangeLat <- if (diff(range(baseLong, na.rm = TRUE)) <= 10.0){
                         diff(range(baseLong, na.rm = TRUE)) * 6
                       } else {
                         diff(range(baseLong, na.rm = TRUE)) * 12
                       }
                       calcLat <- (rangeLat * 2.6)
                       
                       ggplot(data =  map_data('world2')) + 
                         geom_polygon(aes(x=long, y = lat, group = group), 
                                      color = 'black', fill = 'grey') +
                         geom_polygon(data = ggplot2::map_data('world2', 'usa'), #Need to verify that all "single country" datasets are in US
                                      aes(x = long, y = lat, group = group),
                                      fill = 'lightblue', color = 'black') +
                         geom_point(data= fixedCountryLayerData %>%
                                      dplyr::select(where(function(xx){!all(is.na(xx))})) %>% 
                                      select(`long (dec. deg)`, `lat (dec. deg)`) %>%
                                      unique(), 
                                    aes(x = `long (dec. deg)` + 360, #shift y-coordinate 360 degrees into the correct orientation
                                        y = `lat (dec. deg)`),
                                    shape = 'x', color = 'red') +
                         coord_cartesian(xlim = c(mean(baseLong, na.rm = TRUE) + 360 - calcLat,
                                                  mean(baseLong, na.rm = TRUE) + 360 + calcLat),
                                         ylim = c(mean(baseLat, na.rm = TRUE) - rangeLat,
                                                  mean(baseLat, na.rm = TRUE) + rangeLat)) +
                         theme_grey() +
                         xlab("Longitude") + ylab("Latitude") +
                         labs(title = 'Layer Data Map',
                              caption = paste("A map of [", datasetName,
                                              "] sampling sites,  \nusing coordinates found within the layer data.",
                                              sep = ""))
                       
                     }
   # ## maybe if/else within rangeLat check where if small enough, 
   # ggplot(data =  map_data('state') %>% 
   #          filter(region %in% c("oregon", "washington"))) +    #use layer data to pull state info, to make more generalized
   #   geom_polygon(aes(x=long, y = lat, group = group), 
   #                fill = 'grey', color = 'black') +  
   #   geom_point(data=dataset_profile, 
   #              aes(x = `long (dec. deg)`, y = `lat (dec. deg)`), 
   #              shape = 'x', color = 'red') + 
   #   coord_fixed(1.3) + 
   #   theme_grey() +
   #   xlab("Longitude") + ylab("Latitude") +
   #   labs(title = 'Layer Data Map',
   #        caption = paste("A map of [", datasetName,
   #                        "] sampling sites,  \nusing coordinates found within the layer data.",
   #                        sep = ""))
   
   
   
   
   
   
     
   #### PLOTS ####   
   histograms <- 
     if(datasetName %in% ISCN3$profile$dataset_name_sub){
     
                          ggplot(ISCN3$profile %>%
                          filter(dataset_name_sub == datasetName) %>%
                          dplyr::select(where(function(xx){!all(is.na(xx))})) %>%
                                pivot_longer(cols =  intersect(names(.), ISCN3$type_columns$num_cols), 
                                    values_to = 'measurement', names_to = 'type')) +
                                geom_histogram(aes(x=measurement)) +
                                facet_wrap(~type, scales='free') +
                            theme_grey() +
                            labs(title = 'Profile Value Histograms',
                                caption = paste("Histograms detailing measurements in [", datasetName,
                                          "] profile data.", sep = ""))
     
     } else {NA}
     
   depthPlots <- ggplot(fixedCountryLayerData %>%
                        dplyr::select(where(function(xx){!all(is.na(xx))})) %>% 
                              pivot_longer(cols=c('layer_top (cm)', 'layer_bot (cm)'),
                                      values_to='depth') %>%
                              pivot_longer(cols = intersect(names(.), ISCN3$type_columns$num_cols), 
                                      values_to = 'measurement', names_to = 'type')) +
                              geom_line(aes(x=depth, y= measurement, group = profile_name), alpha = 0.5) +
                          facet_wrap(~type, scales='free') +
                          theme_grey() +
                          labs(title = 'Layer Data Depth Plots',
                               caption = paste("Plots of [", datasetName,
                                        "] layer data by depth.", sep = ""))
   
   if(is.na(profileTable)){
     profileTable <- paste("[", datasetName, "] does not contain profile data.", sep = "")
     }
  
#### RETURN ####   
return(list(summaryStudyTable = studyTable,
            profileTable = profileTable,
            layerTable = layerTable,
            profileMap = profileMap,
            layerMap = layerMap,
            profileValueHistograms = histograms,
            depthValuePlots = depthPlots))  
}

#Visuals <- plotGenerate(ISCN3, datasetName = 'Lu_PIMA')
Visuals <- plotGenerate(ISCN3, datasetName = 'Heckman/Swanston Biscuit Burn')
#Visuals <- plotGenerate(ISCN3, datasetName = 'Jorgensen_NPS')

print(Visuals #, na.print = ""
      )

```

## Heckman/Swanston Biscuit Burn
```{r}


#  datasetName <- "Heckman/Swanston Biscuit Burn"
   datasetName <- "Lu_PIMA"

                 


print(profileMap)
```

## Lu_PIMA
```{r}

```

## Heckman lithosequence
```{r}
```

## Oak Ridge National Lab_Loblolly_DWJ
```{r}
```

## Lu_LTER
```{r}
```

## Lehmann Soil C&BC #1
```{r}
```

## Schuur
```{r}
```

## Lehmann NE US soils
```{r}
```

## Vogel
```{r}
```

## Myers-Smith
```{r}
```

## USGS Muhs
```{r}
```

## USGS Harden Yazoo
```{r}
```

## Boby_Mack
```{r}
```

## Kane
```{r}
```

## Bonanza LTER
```{r}
```

## Jorgensen_YKDE
```{r}
```

## UMBS_FASET
```{r}
```

## Jorgensen_ARCN
```{r}
```

## Oak Ridge National Lab_TDE
```{r}
```

## USGS Harden
```{r}
```

## USDA-FS NRS Landscape Carbon Inventory
```{r}
```

## Bockheim
```{r}
```

## Jorgensen_NPS
```{r}
```

## Permafrost_RCN
```{r}
```

## Northern Circumpolar Soil Carbon Database (NCSCD)
```{r}
```

## USGS_S3C
```{r}
```

## AK DSC Project SOC stock computation
```{r}
```

## Worldwide soil carbon and nitrogen data
```{r}
```

## NRCS Sept/2014
```{r}
```


## TODO

- Rename header and file name to reflect dataset_name
- Pull citation and add it to the bib file, check that citation matches the acknowledgement for study
- Check that the clean profile is correct given the orginal information
- Check that the clean layer is correct given the orginal information
- Check that maps are reasonable for the location
- Summerize what the modifications were for this particular dataset
- Create an issue on github with the template below
- Commit and link the commit to the issue

#### Github issue template

- [ ]  Evaluate dataset
- [ ]  Complete template checklist
- [ ]  Write up summary report narrative
- [ ]  Good commenting
- [ ]  External review by someone else

## Citations

Please see [bibtex citation here] for additional details and if you are using ISCN3 please cite.