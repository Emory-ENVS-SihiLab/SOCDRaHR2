# Heckman lithosequence

ISCNv3 issues to resolve for ISCNv3.5

  - Heckman lithosequence
    + Country not set (clearly US)
    + SOC measurements seem to be disconnected from the rest of the data at the layer and profile level
   
    
```{r}
datasetName <- 'Heckman lithosequence'

dataset_study <- citation_raw %>% 
  filter(dataset_name == datasetName) %>%
  select(where(function(xx){!(is.na(xx))})) %>%
  full_join(dataset_raw %>% 
              filter(dataset_name == datasetName) %>%
              select(where(function(xx){!(is.na(xx))})), suffix = c('_citation', '_dataset'))%>%
  standardCast()

##TODO Remove gapfilled soc stocks
dataset_profile <- profile_raw  %>%
  filter(dataset_name_sub == datasetName) %>%
  mutate(`country (country)` = 'United States') %>%
  standardCast() %>%
  filter(dataset_name_soc != 'ISCN SOC stock computation') #remove gapfilled values

dataset_layer <- layer_raw %>%
  filter(dataset_name_sub == datasetName) %>%
  standardCast() %>%
  mutate(`country (country)` = 'United States',
         `soc (g cm-2)` = if_else(dataset_name_soc != 'ISCN SOC stock computation', `soc (g cm-2)`, NA_real_),
         `soc_carbon_flag` = if_else(dataset_name_soc != 'ISCN SOC stock computation', `soc_carbon_flag`, NA_character_),
         `soc_method` = if_else(dataset_name_soc != 'ISCN SOC stock computation', `soc_method`, NA_character_)) %>% 
  group_by(`dataset_name_sub`, `site_name`, `profile_name`, layer_name) %>%
  fill(starts_with('soc')) %>%
  filter(dataset_name_soc == 'ISCN SOC stock computation') %>%
  select(-dataset_name_soc)

#all_study <- bind_rows(dataset_study, all_study)
#all_profile <- bind_rows(dataset_profile, all_profile)
#all_layer <- bind_rows(dataset_layer, all_layer)
```

```{r}
dataset_study
summary(dataset_profile %>% select_if(is.factor))
summary(dataset_layer %>% select_if(is.factor))

ggplot(data =  map_data('state') %>%
         full_join(dataset_profile %>% 
                     mutate(region = 
                              tolower(`state (state_province)`), by = 'region') %>%
                     group_by(region) %>% 
                     tally)) + 
  geom_polygon(aes(x=long, y = lat, group=group, fill = n), 
               color = 'black') +
  coord_fixed(1.3) + 
  theme_nothing() 

ggplot(data =  map_data('state') %>% 
         filter(region %in% c("arizona", "utah", "new mexico", "colorado"))) + 
  geom_polygon(aes(x=long, y = lat, group = group), 
               fill = 'grey', color = 'black') + 
  geom_point(data=dataset_profile, 
             aes(x = `long (dec. deg)`, y = `lat (dec. deg)`),
             shape = 'x', color = 'red') +
  coord_fixed(1.3) +
  theme_nothing() 

dataset_layer %>%
  pivot_longer(cols = intersect(names(.), type_cols$num_cols), values_drop_na = TRUE) %>%
  group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) %>%
  bind_rows(
    dataset_layer %>%
      pivot_longer(cols = intersect(names(.), type_cols$factor_cols), values_drop_na = TRUE) %>%
      group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) ) %>%
  arrange(n) %>%
  knitr::kable()

ggplot(dataset_layer %>% 
         pivot_longer( cols=c('layer_top (cm)', 'layer_bot (cm)'),
                       values_to='depth') %>%
         pivot_longer(cols = intersect(names(.), type_cols$num_cols), 
                      values_to = 'measurement', names_to = 'type')) +
         geom_line(aes(x=depth, y= measurement, group = profile_name)) +
  facet_wrap(~type, scales='free')
```