# Oak Ridge National Lab_Loblolly_DWJ

In this section, we will pull out the `Oak Ridge National Lab_Loblolly_DWJ` from ISCN3 and clean it.
This dataset requires the country to be set to US. Additionally, the hzn in layer and profile reset needs to be reset NA and gapfilled bd with sampling was removed.
We also remove the ISCN SOC stock computation, reducing the duplicated data entries.(CHECK)
   
    
```{r}
## set the dataset name gotten from 
#unique(layer_raw$dataset_name_sub)
datasetName <- 'Oak Ridge National Lab_Loblolly_DWJ'
## subset the citation and dataset description tables and merge them into a study table
dataset_study <- citation_raw %>% 
  filter(dataset_name == datasetName) %>% #pull out the info on the dataset we want here
  select(where(function(xx){!all(is.na(xx))})) %>% #pull out columns where values are not all "NA"
  full_join( #put the the citation and the dataset information together
    dataset_raw %>%
              filter(dataset_name == datasetName) %>% #subset the dataset table
              select(where(function(xx){!all(is.na(xx))})), #only pull columns that are not enitrely NA values
    suffix = c('_citation', '_dataset'))%>% #flag common columns that are not the id columns between the two tables
  standardCast() #go see index.Rmd for this function, mostly recasts the column to the right types
## subset the profile and dataset description tables and merge them into a study table
dataset_profile <- profile_raw %>%
  filter(dataset_name_sub ==  datasetName) %>% #pull out info from desired dataset
  mutate(`country (country)` = 'United States') %>% #set country name to United States
  standardCast() %>%
  filter(dataset_name_soc != 'ISCN SOC stock computation') #remove gapfilled values

dataset_layer <- layer_raw %>% 
  filter(dataset_name_sub == datasetName) %>% #pull out info from desired dataset
  standardCast() %>%
 mutate(`country (country)` = 'United States', #ASK LILLY
         `hzn` = case_when(
           hzn == "?" ~ NA_character_,
           TRUE ~ as.character(hzn)
         ), #replace '?' in hzn with 'NA'
         `bd_tot (g cm-3)` = if_else(bd_method != 'gap-filled value from re-measurement of same plot in 2000', `bd_tot (g cm-3)`, NA_real_),#changing values in "bd_tot (g cm-3)" when row contains "gap-filled value from re-measurement of same plot in 2000"
         `soc (g cm-2)` = if_else(dataset_name_soc != 'ISCN SOC stock computation', `soc (g cm-2)`, NA_real_),#changing values in column "soc (g cm-2)" for if a row in "dataset_name_soc" contains "ISCN"....
         `soc_carbon_flag` = if_else(dataset_name_soc != 'ISCN SOC stock computation', `soc_carbon_flag`, NA_character_),#changing values in "soc_carbon_flag" when row contains "ISCN"
         `soc_method` = if_else(dataset_name_soc != 'ISCN SOC stock computation', `soc_method`, NA_character_)) %>% #changing values in "soc_method" when row contains "ISCN"
  group_by(`dataset_name_sub`, `site_name`, `profile_name`, layer_name) %>% #combines existing tables into one table with seperate components
  fill(starts_with('soc')) %>% #ASK LILLY
  filter(dataset_name_soc == 'ISCN SOC stock computation') %>%
 select(-dataset_name_soc) #removes dataset_name_soc
  

```

Creates a map of the United States and highlights state where latitude and longitude locations are found.

```{r}
dataset_study
summary(dataset_profile %>% select_if(is.factor)) #
summary(dataset_layer %>% select_if(is.factor))

ggplot(data =  map_data('state') %>%
         full_join(dataset_profile %>% 
                     mutate(region = 
                              tolower(`state (state_province)`), by = 'region') %>%
                     group_by(region) %>% 
                     tally)) + 
  geom_polygon(aes(x=long, y = lat, group=group, fill = n), 
               color = 'black') +
  coord_fixed(1.3) + 
  theme_nothing() 
```

```{r}
ggplot(data =  map_data('state') %>% 
         filter(region %in% c("tennessee"))) + 
  geom_polygon(aes(x=long, y = lat, group = group), 
               fill = 'grey', color = 'black') + 
  geom_point(data=dataset_profile, 
             aes(x = `long (dec. deg)`, y = `lat (dec. deg)`),
             shape = 'x', color = 'red') +
  coord_fixed(1.3) +
  theme_nothing() 
```

```{r}
dataset_layer %>%
  pivot_longer(cols = intersect(names(.), type_cols$num_cols), values_drop_na = TRUE) %>%
  group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) %>%
  bind_rows(
    dataset_layer %>%
      pivot_longer(cols = intersect(names(.), type_cols$factor_cols), values_drop_na = TRUE) %>%
      group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) ) %>%
  arrange(n) %>%
  knitr::kable()

##need to remove soc graph and lat long graphs
ggplot(dataset_layer %>% 
         pivot_longer( cols=c('layer_top (cm)', 'layer_bot (cm)'),
                       values_to='depth') %>%
         pivot_longer(cols = intersect(names(.), type_cols$num_cols), 
                      values_to = 'measurement', names_to = 'type')) +
         geom_line(aes(x=depth, y= measurement, group = profile_name)) +
  facet_wrap(~type, scales='free')
```