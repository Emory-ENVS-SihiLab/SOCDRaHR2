---
title: "102_Heckman"
author: "Rita"
date: "2/3/2021"
output: html_document
---

citation_raw <- read_delim('ISCN/ISCN3_citation.csv', delim = ';', col_types = strrep('c', times = 12))
dataset_raw <- read_delim('ISCN/ISCN3_dataset.csv', delim = ';', col_types = strrep('c', times = 19))
layer_raw <- vroom::vroom('ISCN/ISCN3_layer.csv', col_types = strrep('c', times = 95))
profile_raw <-  vroom::vroom('ISCN/ISCN3_profile.csv', col_types = strrep('c', times = 44))


```{r subset_HSBB}
datasetName <- 'Heckman/Swanston Biscuit Burn'
dataset_study <- citation_raw %>% 
  filter(dataset_name == datasetName) %>%
  select(where(function(xx){!all(is.na(xx))})) %>%
  full_join(dataset_raw %>% 
              filter(dataset_name == datasetName) %>%
              select(where(function(xx){!all(is.na(xx))})), suffix = c('_citation', '_dataset'))%>%
  standardCast()
dataset_profile <- profile_raw %>%
  filter(dataset_name_sub ==  datasetName) %>%
   mutate(`soc (g cm-2)` = if_else(grepl('ISCN', dataset_name_soc), 
                                  as.character(NA), `soc (g cm-2)`),
    `soc_carbon_flag` = if_else(grepl('ISCN', dataset_name_soc),
                                as.character(NA), `soc_carbon_flag`),
    `soc_method` = if_else(grepl('ISCN', dataset_name_soc), 
                           as.character(NA), `soc_method`)) %>%
  select(where(function(xx){!all(is.na(xx))})) %>%
  select(-dataset_name_soc)#column now redundent with dataset_name_sub
noNRCS_ISCN3_layer <- layer_raw%>%
  as.data.frame() %>%
  filter(dataset_name_sub != 'NRCS Sept/2014' & dataset_name_sub != ('ISCN 1-1 (2015-12-10)')) %>%
   mutate(`soc (g cm-2)` = if_else(grepl('ISCN', dataset_name_soc), 
                                  as.character(NA), `soc (g cm-2)`),
    `soc_carbon_flag` = if_else(grepl('ISCN', dataset_name_soc),
                                as.character(NA), `soc_carbon_flag`),
    `soc_method` = if_else(grepl('ISCN', dataset_name_soc), 
                           as.character(NA), `soc_method`)) %>%
  select(-dataset_name_soc)%>% #column now redundent with dataset_name_sub
  select(where(function(xx){!all(is.na(xx))}))
  
dataset_profile <- dataset_profile  %>%
  filter(dataset_name_sub == datasetName) %>%
  mutate(`country (country)` = 'United States') %>% #hardcode country
  standardCast() %>%
  rename(dataset_name = 'dataset_name_sub') %>%
  select(dataset_name, `site_name`, `profile_name`,
         `lat (dec. deg)`, `long (dec. deg)`, `datum (datum)`,
         `profile_zero_ref (profile_zero_ref)`,
         `state (state_province)`, `country (country)`, 
         `observation_date (YYYY-MM-DD)`, 
         `soil_series`,`ecoregion`, `surface_veg`,
         `elevation (m)`,  `aspect_deg (degree)`, `slope (percent)`)
dataset_layer <- noNRCS_ISCN3_layer %>%
  filter(dataset_name_sub == datasetName) %>%
  mutate(`country (country)` = 'United States') %>%
  standardCast() %>% 
  rename(dataset_name = 'dataset_name_sub') %>%
  select(dataset_name, `site_name`, `profile_name`, layer_name,
         `lat (dec. deg)`, `long (dec. deg)`, 
         `layer_top (cm)`, `layer_bot (cm)`,
         `hzn`, `hzn_desgn`,
         `c_method`, `oc (percent)`, `13c (‰)`, `14c (‰)`)
  
all_study <- dataset_study
all_profile <- dataset_profile
all_layer <- dataset_layer
#setdiff(c(names(dataset_study), names(dataset_profile), names(dataset_layer)), unlist(type_cols))
```

#Create a summary report for the data contribution including
#1) profile level map of lat/lon
#2) profile level tally of state-country
#3) count of numerical & categorical values
#```{r viz_HSBB}
#print(datasetName)
#head(dataset_study)
#head(dataset_profile)
#head(dataset_layer)


## Tables

The 'r datasetName' is located in ____ in Oregon, USA, the ___ is the zero reference, soil taxon is described in ___ profiles, ___ profiles are drawn from ___ soil series, profiles are split between ____ (see below).

```{r}
#dataset_study
dataset_profile %>% select_if(is.factor) %>% #pull data from profile of this dataset
  summary() %>% #produces result summary
  knitr::kable() #create a table of these values
```

# !!!!!! LOOK AT THIS
```{r}
dataset_layer %>% select_if(is.factor) %>%  #THIS DATA SET MIGHT ONLY HAVE ONE LAYER!!!  LOOK AT HER
  summary() %>%
  knitr::kable()
```


```{r}
dataset_layer %>%
  pivot_longer(cols = intersect(names(.), type_cols$num_cols), values_drop_na = TRUE) %>%
  group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) %>%
  bind_rows(
    dataset_layer %>%
      pivot_longer(cols = intersect(names(.), type_cols$factor_cols), values_drop_na = TRUE) %>%
      group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) ) %>%
  arrange(n) %>%
  knitr::kable()
```

```{r viz_LP}

dataset_study
summary(dataset_profile %>% select_if(is.factor))
summary(dataset_layer %>% select_if(is.factor))



ggplot(data =  map_data('state') %>%
         full_join(dataset_profile %>% 
                     mutate(region = 
                              tolower(`state (state_province)`), by = 'region') %>%
                     group_by(region) %>% 
                     tally)) + 
  geom_polygon(aes(x=long, y = lat, group=group, fill = n), 
               color = 'black') +
  coord_fixed(1.3) + 
  theme_nothing() 

##using location data to plot sites on a state map
ggplot(data =  map_data('state') %>% #pull out relevant info, found in state column
         filter(region %in% c("oregon", "washington"))) + 
  geom_polygon(aes(x=long, y = lat, group = group), 
               fill = 'grey', color = 'black') + 
  geom_point(data=dataset_profile, 
             aes(x = `long (dec. deg)`, y = `lat (dec. deg)`),
             shape = 'x', color = 'red') +
  coord_fixed(1.3) +
  theme_nothing() 

dataset_layer %>%
  pivot_longer(cols = intersect(names(.), type_cols$num_cols), values_drop_na = TRUE) %>%
  group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) %>%
  bind_rows(
    dataset_layer %>%
      pivot_longer(cols = intersect(names(.), type_cols$factor_cols), values_drop_na = TRUE) %>%
      group_by(name) %>% summarize(n = length(value), unique_n = length(unique(value))) ) %>%
  arrange(n) %>%
  knitr::kable()

ggplot(dataset_layer %>% 
         pivot_longer( cols=c('layer_top (cm)', 'layer_bot (cm)'),
                       values_to='depth') %>%
         pivot_longer(cols = c(`oc (percent)`,`13c (‰)`, `14c (‰)`), 
                      values_to = 'measurement', names_to = 'type')) +
  geom_line(aes(x=depth, y= measurement, group = profile_name)) +
  facet_wrap(~type, scales='free')
```
  